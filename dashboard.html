<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard | TikTok Coin Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        background-color: #f8f8f8;
        text-align: center;
      }
      .dashboard-container {
        max-width: 500px;
        width: 100%;
        padding: 40px;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      h1 {
        margin-top: 0;
        font-size: 24px;
      }
      p {
        color: #6b6b6b;
      }
      strong {
        color: #161823;
      }
      #activation-section,
      #tool-section {
        display: none;
        margin-top: 20px;
      }
      input[type="text"] {
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
        text-align: center;
        font-size: 16px;
      }
      button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 4px;
        color: #fff;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      #activation-form button {
        background-color: #28a745;
      }
      #logout-button {
        background-color: #fe2c55;
        margin-top: 20px;
      }
      #activation-message {
        margin-top: 15px;
        color: #dc3545;
        font-weight: 500;
      }
    </style>

    <script>
      // --- THE GUARD SCRIPT (RUNS BEFORE PAGE LOADS) ---
      const token = localStorage.getItem("authToken");
      if (!token) {
        window.location.replace("auth.html"); // Use replace so user can't click "back"
      }
    </script>
  </head>
  <body>
    <div class="dashboard-container">
      <h1 id="welcome-message">Loading...</h1>
      <p id="status-message"></p>

      <!-- Shown if user is logged in but NOT yet activated -->
      <div id="activation-section">
        <p>Please enter your serial key to unlock the tool.</p>
        <form id="activation-form">
          <input
            type="text"
            id="key-input"
            placeholder="Your Serial Key"
            required
          />
          <button type="submit">Activate Key</button>
        </form>
        <p id="activation-message"></p>
      </div>

      <!-- Shown after successful activation -->
      <div id="tool-section">
        <h2>TikTok Coin Tool is Active!</h2>
        <p>Your access will expire on: <strong id="expiry-date"></strong></p>
        <!-- Your actual tool's interface would go here -->
      </div>

      <button id="logout-button">Logout</button>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const API_URL = "https://tiktok-coin-api.onrender.com/api"; // <-- IMPORTANT: USE YOUR LIVE RENDER URL
        const token = localStorage.getItem("authToken");

        const welcomeMsg = document.getElementById("welcome-message");
        const activationSection = document.getElementById("activation-section");
        const toolSection = document.getElementById("tool-section");
        const expiryDateEl = document.getElementById("expiry-date");
        const activationForm = document.getElementById("activation-form");
        const keyInput = document.getElementById("key-input");
        const activationMessage = document.getElementById("activation-message");
        const logoutButton = document.getElementById("logout-button");

        // --- Check Status with the Backend ---
        try {
          const res = await fetch(`${API_URL}/status`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (res.status === 401 || res.status === 403) {
            localStorage.removeItem("authToken");
            window.location.replace("auth.html");
            return;
          }

          const data = await res.json();
          welcomeMsg.textContent = `Welcome, ${data.email}!`;

          if (data.isActivated) {
            toolSection.style.display = "block";
            expiryDateEl.textContent = new Date(data.expires).toLocaleString();
          } else {
            activationSection.style.display = "block";
          }
        } catch (err) {
          welcomeMsg.textContent = "Error connecting to server.";
        }

        // --- Activation Form Logic ---
        activationForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const key = keyInput.value.trim();
          if (!key) return;

          try {
            const res = await fetch(`${API_URL}/activate`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ key }),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);

            window.location.reload(); // Reload the page to show the activated state
          } catch (err) {
            activationMessage.textContent = err.message;
          }
        });

        // --- Logout Logic ---
        logoutButton.addEventListener("click", () => {
          localStorage.removeItem("authToken");
          window.location.href = "auth.html";
        });
      });
    </script>
  </body>
</html>
